#!/bin/bash

# ================= CONFIG =================
SITE_NAME="publisher.com"
WP_PATH="/var/www/publisher/wordpress"

DB_NAME="publisher_db"
DB_USER="publisher_user"
DB_PASS="Pul!sh3R@2025"
DB_HOST="localhost"

BACKUP_BASE="/backups/wordpress"
RETENTION_DAYS=7
DATE=$(date +"%Y-%m-%d")

# =========================================

BACKUP_DIR="${BACKUP_BASE}/${DATE}"
LOG_FILE="${BACKUP_BASE}/backup.log"

mkdir -p "$BACKUP_DIR"

echo "[$(date)] Backup started" >> "$LOG_FILE"

# -------- FILES BACKUP --------
tar -czf "${BACKUP_DIR}/${SITE_NAME}_files_${DATE}.tar.gz" \
    -C "$WP_PATH" . >> "$LOG_FILE" 2>&1

# -------- DATABASE BACKUP --------
mysqldump -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" \
    | gzip > "${BACKUP_DIR}/${SITE_NAME}_db_${DATE}.sql.gz"

if [ $? -ne 0 ]; then
    echo "[$(date)] Database backup FAILED" >> "$LOG_FILE"
else
    echo "[$(date)] Database backup completed" >> "$LOG_FILE"
fi

# -------- RETENTION (7 days) --------
find "$BACKUP_BASE" -mindepth 1 -maxdepth 1 -type d -mtime +$RETENTION_DAYS -exec rm -rf {} \;

echo "[$(date)] Backup finished" >> "$LOG_FILE"
echo "---------------------------------" >> "$LOG_FILE"
