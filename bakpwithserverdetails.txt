#!/bin/bash

# ================= CONFIG =================
SITE_NAME="publisher.com"
WP_PATH="/var/www/publisher/wordpress"

DB_NAME="publisher_db"
DB_USER="publisher_user"
DB_PASS="Pul!sh3R@2025"
DB_HOST="localhost"

BACKUP_BASE="/backups/wordpress"
RETENTION_DAYS=7

# Minimum FREE disk percentage required
MIN_FREE_PERCENT=20

DATE=$(date +"%Y-%m-%d")
TIMESTAMP() { date +"%Y-%m-%d %H:%M:%S"; }

# =========================================

BACKUP_DIR="${BACKUP_BASE}/${DATE}"
LOG_FILE="${BACKUP_BASE}/backup.log"

mkdir -p "$BACKUP_BASE"

# -------- SYSTEM INFO FUNCTION --------
system_info() {
    HOSTNAME=$(hostname)

    # RAM usage %
    RAM_USAGE=$(free | awk '/Mem:/ {printf "%.2f", ($3/$2)*100}')

    # CPU usage %
    CPU_USAGE=$(top -bn1 | awk '/Cpu\(s\)/ {printf "%.0f", 100 - $8}')

    # Disk info (where backups are stored)
    DISK_TOTAL=$(df -h "$BACKUP_BASE" | awk 'NR==2 {print $2}')
    DISK_FREE=$(df -h "$BACKUP_BASE" | awk 'NR==2 {print $4}')

    echo "Computer Name: ${HOSTNAME}, RAM Usage: ${RAM_USAGE}%, CPU Usage: ${CPU_USAGE}%, Total Disk: ${DISK_TOTAL}, Free Space: ${DISK_FREE}"
}

# -------- DISK SPACE CHECK (PERCENTAGE) --------
USED_PERCENT=$(df -P "$BACKUP_BASE" | awk 'NR==2 {gsub("%","",$5); print $5}')
FREE_PERCENT=$((100 - USED_PERCENT))

if [ "$FREE_PERCENT" -lt "$MIN_FREE_PERCENT" ]; then
    echo "[$(TIMESTAMP)] Backup aborted: Low disk space (${FREE_PERCENT}% free, ${MIN_FREE_PERCENT}% required) | $(system_info)" \
        >> "$LOG_FILE"
    exit 1
fi

mkdir -p "$BACKUP_DIR"

# -------- START LOG --------
echo "[$(TIMESTAMP)] Backup started | $(system_info)" >> "$LOG_FILE"

# -------- FILES BACKUP --------
tar -czf "${BACKUP_DIR}/${SITE_NAME}_files_${DATE}.tar.gz" \
    -C "$(dirname "$WP_PATH")" "$(basename "$WP_PATH")" \
    >> "$LOG_FILE" 2>&1


# -------- DATABASE BACKUP --------
mysqldump -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" \
    | gzip > "${BACKUP_DIR}/${SITE_NAME}_db_${DATE}.sql.gz"

if [ $? -ne 0 ]; then
    echo "[$(TIMESTAMP)] Database backup FAILED" >> "$LOG_FILE"
else
    echo "[$(TIMESTAMP)] Database backup completed" >> "$LOG_FILE"
fi

# -------- RETENTION (7 days) --------
find "$BACKUP_BASE" -mindepth 1 -maxdepth 1 -type d \
    -mtime +$RETENTION_DAYS -exec rm -rf {} \;

# -------- END LOG --------
echo "[$(TIMESTAMP)] Backup finished | $(system_info)" >> "$LOG_FILE"
echo "------------------------------------------------------------" >> "$LOG_FILE"
